<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dua Educational Portal ‚Äî Complete Working Version</title>
  <style>
    :root{
      --bg: linear-gradient(135deg,#16d2e7,#06434b);
      --card:#f7f8f9;
      --accent:#4f05fd;
      --accent2:#f404a0;
      --accent3:#f5f4f67e;
      --muted:#1368df35;
      --radius:10px;
      --max:auto;
      --shadow: 0 8px 20px rgba(16, 84, 244, 0.08);
      font-family: Inter, system-ui, Arial, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:#011a2a}
    .wrap{max-width:1200px;margin:0 auto;padding:10px}
    header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:12px 20px;border-radius:10px;box-shadow:var(--shadow);margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:15px}
    .brand img{width:50px;height:50px;border-radius:10px;object-fit:cover}
    .brand h1{font-size:20px;margin:0;color:#fff}
    .brand .subtitle{font-size:12px;color:rgba(255,255,255,0.9)}
    nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    nav a{color:#f5f5f3;text-decoration:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;transition:background 0.3s}
    nav a:hover{background:rgba(255,255,255,0.2)}
    .layout{display:grid;grid-template-columns:1fr;gap:20px;margin-top:20px}
    @media(min-width:768px){.layout{grid-template-columns:1fr 350px}}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:20px}
    h2{margin:0 0 15px;color:var(--accent);font-size:22px}
    h3{margin:15px 0;color:#333}
    h4{margin:10px 0;color:var(--accent2)}
    label{display:block;font-weight:500;margin-bottom:8px;color:#334155}
    input,select,textarea,button{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px;font-size:14px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--accent);border-color:var(--accent)}
    .btn-row{display:flex;gap:10px;margin-top:15px}
    .btn{cursor:pointer;border:none;padding:12px 20px;border-radius:8px;font-weight:700;font-size:14px;transition:all 0.3s}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .btn-primary:hover{opacity:0.9;transform:translateY(-2px)}
    .btn-ghost{background:transparent;border:2px solid var(--accent);color:var(--accent)}
    .btn-ghost:hover{background:var(--accent);color:#fff}
    .small{font-size:12px;color:#64748b}
    .result-row{padding:12px;border-radius:8px;background:#f8fafc;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;border:1px solid #e2e8f0}
    .table{width:100%;border-collapse:collapse;margin-top:15px;font-size:12px}
    .table th,.table td{border:1px solid #e2e8f0;padding:8px;background:#fff;text-align:left}
    .table th{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .hidden{display:none!important}
    .visible{display:block}
    .stu-photo{width:100px;height:100px;border-radius:8px;object-fit:cover;border:2px solid #ddd}
    .confirm-box{display:flex;gap:15px;align-items:center;padding:15px;border-radius:10px;background:linear-gradient(180deg,#ecfeff,#f0f9ff);border:1px solid #bae6fd;margin-top:20px}
    .toast{position:fixed;right:20px;bottom:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;display:none;font-weight:500}
    .error{background:#ef4444}
    .warning{background:#f59e0b}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:10000}
    .modal{width:90%;max-width:500px;background:#fff;border-radius:12px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
    .modal h3{margin-top:0;color:var(--accent)}
    .modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
    .info-box{padding:15px;background:#f0f9ff;border-radius:8px;border-left:4px solid var(--accent);margin:15px 0}
    .status-approved{color:#10b981;font-weight:bold}
    .status-pending{color:#f59e0b;font-weight:bold}
    .status-rejected{color:#ef4444;font-weight:bold}
    .photo-preview{width:120px;height:140px;object-fit:cover;border-radius:8px;border:2px solid #ddd;margin:10px auto}
    .footer{text-align:center;margin-top:30px;padding:20px 0;color:#64748b;font-size:12px;border-top:1px solid #e2e8f0}
    .demo-data{background:#f8fafc;padding:10px;border-radius:8px;margin:10px 0}
    .demo-data h5{margin-bottom:5px;color:#475569}
    .demo-data ul{padding-left:20px;color:#64748b}
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="brand">
      <img src="logo dua Academy kamoon shaheed.PNG" alt="Logo" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\"><rect width=\"50\" height=\"50\" fill=\"%234f05fd\"/><text x=\"25\" y=\"30\" font-family=\"Arial\" font-size=\"14\" fill=\"white\" text-anchor=\"middle\">DEA</text></svg>'">
      <div>
        <h1>Dua Educational Academy</h1>
        <div class="subtitle">Kamoon Shaheed - Online Portal</div>
      </div>
    </div>
    <nav>
      <a onclick="openSection('home')">üè† Home</a>
      <a onclick="openSection('apply')">üìù Apply</a>
      <a onclick="openSection('slip')">üìÑ Slip</a>
      <a onclick="openSection('result')">üìä Result</a>
      <a onclick="openSection('admin')">üîê Admin</a>
    </nav>
  </header>

  <main class="layout">
    
    <!-- Home Section -->
    <section id="home" class="card">
      <div style="text-align:center;padding:20px">
        <img src="logo dua Academy kamoon shaheed.PNG" width="200" height="200" style="border-radius:15px;margin-bottom:20px" alt="Academy Logo" onerror="this.style.display='none'">
        <h2>Welcome to Dua Educational Academy</h2>
        <p style="font-size:16px;color:#475569;margin-bottom:30px">Official Online Portal ‚Äî Student Registration, Admit Slips, Results & Admin Panel</p>
        
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:20px 0">
          <button class="btn btn-primary" onclick="openSection('apply')" style="width:auto">üìù Apply Now</button>
          <button class="btn btn-primary" onclick="openSection('slip')" style="width:auto">üìÑ Get Admit Slip</button>
          <button class="btn btn-primary" onclick="openSection('result')" style="width:auto">üìä Check Result</button>
          <button class="btn btn-ghost" onclick="openSection('admin')" style="width:auto">üîê Admin Login</button>
        </div>
        
        <div class="info-box">
          <h4>üì¢ Important Information</h4>
          <p><strong>English:</strong> Submit form ‚Üí Get roll number ‚Üí Check slip after admin approval (within 24 hours).</p>
          <p><strong>Sindhi:</strong> ŸÅÿßÿ±ŸÖ ÿ¨ŸÖÿπ ⁄™ÿ±ÿßŸäŸà ‚Üí ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ± ÿ≠ÿßÿµŸÑ ⁄™ÿ±ŸäŸà ‚Üí ÿßŸä⁄äŸÖŸÜ ÿ¨Ÿä ŸÖŸÜÿ∏Ÿàÿ±Ÿä ⁄©ÿßŸÜ ŸæŸàÿ°Ÿê ÿ≥ŸÑŸæ ⁄èÿ≥Ÿà (24 ⁄™ŸÑÿß⁄™ŸÜ ÿßŸÜÿØÿ±).</p>
        </div>
        
        <div class="demo-data">
          <h5>üí° Test Data for Demo:</h5>
          <ul>
            <li>Roll Numbers: 801, 802, 803</li>
            <li>Admin Password: <strong>uk6091</strong></li>
            <li>Test CNIC: 4220112345678</li>
          </ul>
        </div>
        
        <h3 style="margin-top:30px">üë®‚Äçüè´ Contact Information</h3>
        <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin-top:20px">
          <div style="text-align:center;padding:15px;background:#fff;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);width:180px">
            <div style="font-weight:bold;color:var(--accent);margin-bottom:5px">Director</div>
            <div>Noor Muhammad Musafir Soomro</div>
            <div style="margin-top:10px"><a href="tel:03083442741" style="color:#10b981;text-decoration:none">üìû 0308-3442741</a></div>
          </div>
          <div style="text-align:center;padding:15px;background:#fff;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);width:180px">
            <div style="font-weight:bold;color:var(--accent);margin-bottom:5px">Pattern</div>
            <div>Gada Hussain Soomro</div>
            <div style="margin-top:10px">
              <a href="tel:03083442741" style="color:#10b981;text-decoration:none">üìû 0308-3442741</a><br>
              <a href="https://wa.me/923083442741" style="color:#25D366;text-decoration:none">üì± WhatsApp</a>
            </div>
          </div>
          <div style="text-align:center;padding:15px;background:#fff;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);width:180px">
            <div style="font-weight:bold;color:var(--accent);margin-bottom:5px">Web Developer</div>
            <div>Ubedullah Khan</div>
            <div style="margin-top:10px">
              <a href="tel:03013402708" style="color:#10b981;text-decoration:none">üìû 0301-3402708</a><br>
              <a href="https://wa.me/923013402708" style="color:#25D366;text-decoration:none">üì± WhatsApp</a>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Apply Section -->
    <section id="apply" class="card hidden">
      <h2>üìù Student Application Form</h2>
      
      <div class="info-box">
        <p><strong>Instructions:</strong> Fill all fields. After submission, you'll get a roll number. Save it for future reference.</p>
      </div>
      
      <form id="applyForm">
        <h4>üë§ Student Information</h4>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
          <div>
            <label>First Name *</label>
            <input type="text" id="firstName" placeholder="Enter first name" required>
          </div>
          <div>
            <label>Last Name *</label>
            <input type="text" id="lastName" placeholder="Enter last name" required>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
          <div>
            <label>Gender *</label>
            <select id="gender" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div>
            <label>Date of Birth *</label>
            <input type="date" id="dob" required>
          </div>
        </div>
        
        <div style="margin-bottom:15px">
          <label>CNIC (13 digits without dashes) *</label>
          <input type="text" id="cnic" placeholder="4220112345678" maxlength="13" pattern="[0-9]{13}" required>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Class/Grade *</label>
          <select id="class" required>
            <option value="">Select Class</option>
            <option value="5">Class 5</option>
            <option value="6">Class 6</option>
            <option value="7">Class 7</option>
            <option value="8">Class 8</option>
            <option value="9">Class 9</option>
            <option value="10">Class 10</option>
            <option value="11-Medical">11th - Medical</option>
            <option value="11-Eng">11th - Engineering</option>
            <option value="12-Medical">12th - Medical</option>
            <option value="12-Eng">12th - Engineering</option>
          </select>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Previous School Name</label>
          <input type="text" id="previousSchool" placeholder="Name of previous school">
        </div>
        
        <div style="margin-bottom:15px">
          <label>WhatsApp Number (11 digits) *</label>
          <input type="text" id="whatsapp" placeholder="03001234567" maxlength="11" pattern="[0-9]{11}" required>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Student Photo (Optional)</label>
          <input type="file" id="studentPhoto" accept="image/*">
          <div id="photoPreview" class="hidden" style="margin-top:10px">
            <img id="previewImage" class="photo-preview" alt="Photo Preview">
          </div>
        </div>
        
        <h4>üë® Father Information</h4>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
          <div>
            <label>Father's First Name *</label>
            <input type="text" id="fatherFirstName" placeholder="Father's first name" required>
          </div>
          <div>
            <label>Father's Last Name *</label>
            <input type="text" id="fatherLastName" placeholder="Father's last name" required>
          </div>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Father's CNIC (13 digits) *</label>
          <input type="text" id="fatherCnic" placeholder="4220112345678" maxlength="13" pattern="[0-9]{13}" required>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Father's Occupation</label>
          <input type="text" id="fatherOccupation" placeholder="Occupation">
        </div>
        
        <h4>üí∞ Payment Information</h4>
        
        <div style="background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:15px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:bold">Application Fee</div>
              <div class="small">Fixed amount for all classes</div>
            </div>
            <div style="font-size:24px;font-weight:bold;color:var(--accent)">Rs. 650</div>
          </div>
          <div class="small" style="margin-top:10px;color:#64748b">
            JazzCash: 03083842741 (Gada Hussain Soomro)<br>
            After payment, upload screenshot below
          </div>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Payment Method</label>
          <select id="paymentMethod" required>
            <option value="">Select Payment Method</option>
            <option value="JazzCash">JazzCash</option>
            <option value="EasyPaisa">EasyPaisa</option>
            <option value="Bank Transfer">Bank Transfer</option>
            <option value="Cash">Cash</option>
          </select>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Transaction ID / Reference Number *</label>
          <input type="text" id="transactionId" placeholder="Enter transaction ID" required>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Sender Mobile Number (11 digits) *</label>
          <input type="text" id="senderNumber" placeholder="03001234567" maxlength="11" pattern="[0-9]{11}" required>
        </div>
        
        <div style="margin-bottom:15px">
          <label>Payment Screenshot (Optional but recommended)</label>
          <input type="file" id="paymentScreenshot" accept="image/*">
        </div>
        
        <div class="btn-row">
          <button type="button" class="btn btn-primary" onclick="submitApplication()">‚úÖ Submit Application</button>
          <button type="button" class="btn btn-ghost" onclick="resetForm()">üîÑ Reset Form</button>
          <button type="button" class="btn btn-ghost" onclick="openSection('home')">üè† Back to Home</button>
        </div>
      </form>
      
      <div id="confirmationMessage" class="hidden">
        <div class="confirm-box">
          <div style="text-align:center">
            <div style="font-size:48px;color:#10b981;margin-bottom:10px">‚úÖ</div>
            <h3 style="color:#10b981">Application Submitted Successfully!</h3>
          </div>
          <div style="flex:1">
            <div style="background:#fff;padding:15px;border-radius:8px;margin-bottom:15px">
              <div class="small">Your Roll Number</div>
              <div id="generatedRoll" style="font-size:32px;font-weight:bold;color:var(--accent);letter-spacing:2px"></div>
            </div>
            
            <div id="applicationDetails" style="margin-bottom:15px"></div>
            
            <div class="info-box">
              <p><strong>Important:</strong> Save your roll number! You can:</p>
              <ul style="padding-left:20px;margin-top:10px">
                <li>Check admit slip after admin approval</li>
                <li>View results when uploaded</li>
                <li>Contact admin with your roll number</li>
              </ul>
            </div>
            
            <div class="btn-row">
              <button class="btn btn-primary" onclick="copyRollNumber()">üìã Copy Roll Number</button>
              <button class="btn btn-ghost" onclick="printApplication()">üñ®Ô∏è Print Details</button>
              <button class="btn btn-ghost" onclick="newApplication()">üìù New Application</button>
            </div>
          </div>
        </div>
      </div>
      
      <div id="applicationsList" style="margin-top:30px">
        <h4>üìã Recent Applications</h4>
        <div id="applicationsContainer">
          <!-- Applications will be loaded here -->
        </div>
      </div>
    </section>
    
    <!-- Slip Section -->
    <section id="slip" class="card hidden">
      <h2>üìÑ Admit Slip Generator</h2>
      
      <div class="info-box">
        <p>Enter your roll number to generate admit slip. Slip will show only after admin approval.</p>
      </div>
      
      <div style="max-width:400px;margin:0 auto;padding:20px">
        <label>Enter Roll Number *</label>
        <input type="text" id="slipRollNumber" placeholder="e.g., 801">
        
        <div class="btn-row">
          <button class="btn btn-primary" onclick="generateSlip()">üîç Generate Slip</button>
          <button class="btn btn-ghost" onclick="openSection('home')">üè† Back to Home</button>
        </div>
      </div>
      
      <div id="slipContainer" style="margin-top:30px"></div>
    </section>
    
    <!-- Result Section -->
    <section id="result" class="card hidden">
      <h2>üìä Result Checker</h2>
      
      <div class="info-box">
        <p>Enter roll number to check your result. Results are uploaded by admin.</p>
      </div>
      
      <div style="max-width:400px;margin:0 auto;padding:20px">
        <label>Enter Roll Number *</label>
        <input type="text" id="resultRollNumber" placeholder="e.g., 801">
        
        <div class="btn-row">
          <button class="btn btn-primary" onclick="checkResult()">üîç Check Result</button>
          <button class="btn btn-ghost" onclick="openSection('home')">üè† Back to Home</button>
        </div>
      </div>
      
      <div id="resultContainer" style="margin-top:30px"></div>
    </section>
    
    <!-- Admin Section -->
    <section id="admin" class="card hidden">
      <h2>üîê Admin Panel</h2>
      
      <div id="loginSection">
        <div class="info-box">
          <p>Enter admin password to access the dashboard.</p>
        </div>
        
        <div style="max-width:400px;margin:0 auto;padding:20px">
          <label>Admin Password *</label>
          <input type="password" id="adminPassword" placeholder="Enter password">
          
          <div class="btn-row">
            <button class="btn btn-primary" onclick="adminLogin()">üîì Login</button>
            <button class="btn btn-ghost" onclick="openSection('home')">üè† Back to Home</button>
          </div>
        </div>
      </div>
      
      <div id="adminDashboard" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h3>Admin Dashboard</h3>
          <button class="btn btn-ghost" onclick="adminLogout()">üö™ Logout</button>
        </div>
        
        <div class="info-box">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:bold">Statistics</div>
              <div class="small">Total applications: <span id="totalApplications">0</span></div>
            </div>
            <button class="btn btn-primary" onclick="exportData()">üì• Export Data</button>
          </div>
        </div>
        
        <div style="margin:20px 0">
          <h4>üìã All Applications</h4>
          <div style="overflow-x:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Roll</th>
                  <th>Name</th>
                  <th>Class</th>
                  <th>WhatsApp</th>
                  <th>Fee</th>
                  <th>Status</th>
                  <th>Marks</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminTableBody">
                <!-- Applications will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div style="margin:20px 0">
          <h4>‚ûï Add/Update Marks</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;align-items:end">
            <div>
              <label>Roll Number</label>
              <input type="text" id="marksRoll" placeholder="Enter roll number">
            </div>
            <div>
              <label>Marks (0-100)</label>
              <input type="number" id="marksValue" min="0" max="100" placeholder="Enter marks">
            </div>
            <div>
              <button class="btn btn-primary" onclick="addMarks()">‚úÖ Add Marks</button>
            </div>
          </div>
        </div>
        
        <div style="margin:20px 0">
          <h4>‚öôÔ∏è Database Tools</h4>
          <div class="btn-row">
            <button class="btn btn-ghost" onclick="clearAllData()" style="background:#fee2e2;color:#dc2626">üóëÔ∏è Clear All Data</button>
            <button class="btn btn-ghost" onclick="createTestData()">üß™ Create Test Data</button>
            <button class="btn btn-ghost" onclick="showStorageInfo()">üíæ Storage Info</button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Right Sidebar -->
    <aside style="grid-column:2">
      <div class="card" style="position:sticky;top:20px">
        <h3>üìä Quick Stats</h3>
        <div style="margin:15px 0">
          <div style="display:flex;justify-content:space-between;margin-bottom:10px">
            <span>Total Applications:</span>
            <span id="statsTotal" style="font-weight:bold">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:10px">
            <span>Approved:</span>
            <span id="statsApproved" style="color:#10b981;font-weight:bold">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:10px">
            <span>Pending:</span>
            <span id="statsPending" style="color:#f59e0b;font-weight:bold">0</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Latest Roll:</span>
            <span id="statsLatestRoll" style="color:var(--accent);font-weight:bold">-</span>
          </div>
        </div>
        
        <h3>üîî Quick Actions</h3>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:15px">
          <button class="btn btn-primary" onclick="openSection('apply')">üìù New Application</button>
          <button class="btn btn-ghost" onclick="openSection('slip')">üìÑ Check Slip</button>
          <button class="btn btn-ghost" onclick="openSection('result')">üìä Check Result</button>
        </div>
        
        <h3 style="margin-top:20px">üìû Contact Support</h3>
        <div class="small" style="margin-top:10px">
          <div>üì± WhatsApp: 0301-3402708</div>
          <div>üìß Email: support@duaacademy.edu.pk</div>
          <div style="margin-top:10px">
            <a href="https://www.facebook.com/groups/600983602483223" target="_blank" style="color:var(--accent);text-decoration:none">üìò Facebook Group</a><br>
            <a href="https://chat.whatsapp.com/GzjZLkgNvS8LQpIpqm1li5" target="_blank" style="color:#25D366;text-decoration:none">üí¨ WhatsApp Group</a>
          </div>
        </div>
      </div>
    </aside>
  </main>
  
  <div class="footer">
    <p>¬© 2024 Dua Educational Academy Kamoon Shaheed. All rights reserved.</p>
    <p class="small">This portal stores data locally in your browser. Data persists unless cleared.</p>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-backdrop">
  <div class="modal">
    <h3 id="modalTitle">Confirm Action</h3>
    <p id="modalMessage">Are you sure you want to proceed?</p>
    <div class="modal-buttons">
      <button class="btn btn-ghost" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAction()">Confirm</button>
    </div>
  </div>
</div>

<script>
// ==================== CONFIGURATION ====================
const CONFIG = {
  ADMIN_PASSWORD: 'uk6091',
  APPLICATION_FEE: 650,
  START_ROLL_NUMBER: 801,
  ACADEMY_NAME: 'Dua Educational Academy Kamoon Shaheed',
  STORAGE_KEYS: {
    APPLICATIONS: 'dua_academy_applications',
    MARKS: 'dua_academy_marks',
    NEXT_ROLL: 'dua_academy_next_roll'
  }
};

// ==================== UTILITY FUNCTIONS ====================
function showToast(message, type = 'info', duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast';
  if (type === 'error') toast.classList.add('error');
  if (type === 'warning') toast.classList.add('warning');
  toast.style.display = 'block';
  setTimeout(() => {
    toast.style.display = 'none';
  }, duration);
}

function showModal(title, message, callback) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMessage').textContent = message;
  document.getElementById('confirmModal').style.display = 'flex';
  window.modalCallback = callback;
}

function hideModal() {
  document.getElementById('confirmModal').style.display = 'none';
  window.modalCallback = null;
}

function confirmAction() {
  if (window.modalCallback) {
    window.modalCallback();
  }
  hideModal();
}

function openSection(sectionId) {
  // Hide all sections
  document.querySelectorAll('section.card').forEach(section => {
    section.classList.add('hidden');
  });
  
  // Show selected section
  const section = document.getElementById(sectionId);
  if (section) {
    section.classList.remove('hidden');
  }
  
  // Update stats
  updateStats();
  
  // Load data if needed
  if (sectionId === 'apply') {
    loadApplications();
  } else if (sectionId === 'admin' && isAdminLoggedIn()) {
    showAdminDashboard();
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ==================== STORAGE FUNCTIONS ====================
function getNextRollNumber() {
  let nextRoll = localStorage.getItem(CONFIG.STORAGE_KEYS.NEXT_ROLL);
  if (!nextRoll) {
    nextRoll = CONFIG.START_ROLL_NUMBER;
    localStorage.setItem(CONFIG.STORAGE_KEYS.NEXT_ROLL, nextRoll);
  }
  
  // Increment for next time
  localStorage.setItem(CONFIG.STORAGE_KEYS.NEXT_ROLL, String(parseInt(nextRoll) + 1));
  
  return nextRoll;
}

function getApplications() {
  try {
    const data = localStorage.getItem(CONFIG.STORAGE_KEYS.APPLICATIONS);
    return data ? JSON.parse(data) : [];
  } catch (error) {
    console.error('Error reading applications:', error);
    showToast('Error reading data from storage', 'error');
    return [];
  }
}

function saveApplications(applications) {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEYS.APPLICATIONS, JSON.stringify(applications));
    updateStats();
    return true;
  } catch (error) {
    console.error('Error saving applications:', error);
    showToast('Error saving data to storage', 'error');
    return false;
  }
}

function getMarks() {
  try {
    const data = localStorage.getItem(CONFIG.STORAGE_KEYS.MARKS);
    return data ? JSON.parse(data) : [];
  } catch (error) {
    console.error('Error reading marks:', error);
    return [];
  }
}

function saveMarks(marks) {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEYS.MARKS, JSON.stringify(marks));
    return true;
  } catch (error) {
    console.error('Error saving marks:', error);
    return false;
  }
}

// ==================== APPLICATION FUNCTIONS ====================
function submitApplication() {
  // Get form values
  const firstName = document.getElementById('firstName').value.trim();
  const lastName = document.getElementById('lastName').value.trim();
  const gender = document.getElementById('gender').value;
  const dob = document.getElementById('dob').value;
  const cnic = document.getElementById('cnic').value.trim();
  const studentClass = document.getElementById('class').value;
  const previousSchool = document.getElementById('previousSchool').value.trim();
  const whatsapp = document.getElementById('whatsapp').value.trim();
  const fatherFirstName = document.getElementById('fatherFirstName').value.trim();
  const fatherLastName = document.getElementById('fatherLastName').value.trim();
  const fatherCnic = document.getElementById('fatherCnic').value.trim();
  const fatherOccupation = document.getElementById('fatherOccupation').value.trim();
  const paymentMethod = document.getElementById('paymentMethod').value;
  const transactionId = document.getElementById('transactionId').value.trim();
  const senderNumber = document.getElementById('senderNumber').value.trim();
  
  // Validation
  if (!firstName || !lastName) {
    showToast('Please enter student name', 'error');
    return;
  }
  
  if (!gender) {
    showToast('Please select gender', 'error');
    return;
  }
  
  if (!dob) {
    showToast('Please select date of birth', 'error');
    return;
  }
  
  if (!cnic || cnic.length !== 13) {
    showToast('CNIC must be 13 digits', 'error');
    return;
  }
  
  if (!studentClass) {
    showToast('Please select class', 'error');
    return;
  }
  
  if (!whatsapp || whatsapp.length !== 11) {
    showToast('WhatsApp number must be 11 digits', 'error');
    return;
  }
  
  if (!fatherFirstName || !fatherLastName) {
    showToast('Please enter father\'s name', 'error');
    return;
  }
  
  if (!fatherCnic || fatherCnic.length !== 13) {
    showToast('Father CNIC must be 13 digits', 'error');
    return;
  }
  
  if (!paymentMethod) {
    showToast('Please select payment method', 'error');
    return;
  }
  
  if (!transactionId) {
    showToast('Please enter transaction ID', 'error');
    return;
  }
  
  if (!senderNumber || senderNumber.length !== 11) {
    showToast('Sender number must be 11 digits', 'error');
    return;
  }
  
  // Generate roll number
  const rollNumber = getNextRollNumber();
  
  // Handle photo file
  const photoFile = document.getElementById('studentPhoto').files[0];
  let photoData = '';
  if (photoFile) {
    const reader = new FileReader();
    reader.onload = function(e) {
      photoData = e.target.result;
      completeApplicationSubmission(rollNumber, firstName, lastName, gender, dob, cnic, studentClass, 
        previousSchool, whatsapp, fatherFirstName, fatherLastName, fatherCnic, fatherOccupation,
        paymentMethod, transactionId, senderNumber, photoData);
    };
    reader.readAsDataURL(photoFile);
  } else {
    completeApplicationSubmission(rollNumber, firstName, lastName, gender, dob, cnic, studentClass, 
      previousSchool, whatsapp, fatherFirstName, fatherLastName, fatherCnic, fatherOccupation,
      paymentMethod, transactionId, senderNumber, '');
  }
}

function completeApplicationSubmission(rollNumber, firstName, lastName, gender, dob, cnic, studentClass, 
  previousSchool, whatsapp, fatherFirstName, fatherLastName, fatherCnic, fatherOccupation,
  paymentMethod, transactionId, senderNumber, photoData) {
  
  // Create application object
  const application = {
    id: Date.now(),
    rollNumber: rollNumber,
    firstName: firstName,
    lastName: lastName,
    fullName: `${firstName} ${lastName}`,
    gender: gender,
    dob: dob,
    cnic: cnic,
    class: studentClass,
    previousSchool: previousSchool,
    whatsapp: whatsapp,
    fatherFirstName: fatherFirstName,
    fatherLastName: fatherLastName,
    fatherFullName: `${fatherFirstName} ${fatherLastName}`,
    fatherCnic: fatherCnic,
    fatherOccupation: fatherOccupation,
    paymentMethod: paymentMethod,
    transactionId: transactionId,
    senderNumber: senderNumber,
    fee: CONFIG.APPLICATION_FEE,
    status: 'pending', // pending, approved, rejected
    photo: photoData,
    submissionDate: new Date().toISOString(),
    approvedDate: null,
    approvedBy: null
  };
  
  // Get existing applications
  const applications = getApplications();
  
  // Add new application
  applications.push(application);
  
  // Save to storage
  if (saveApplications(applications)) {
    // Show confirmation
    showConfirmation(application);
    showToast(`Application submitted successfully! Roll Number: ${rollNumber}`, 'info');
  }
}

function showConfirmation(application) {
  // Hide form
  document.getElementById('applyForm').classList.add('hidden');
  
  // Show confirmation
  document.getElementById('confirmationMessage').classList.remove('hidden');
  
  // Set roll number
  document.getElementById('generatedRoll').textContent = application.rollNumber;
  
  // Set application details
  document.getElementById('applicationDetails').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
      <div>
        <div class="small">Student Name</div>
        <div style="font-weight:bold">${application.fullName}</div>
      </div>
      <div>
        <div class="small">Class</div>
        <div style="font-weight:bold">${application.class}</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
      <div>
        <div class="small">Father's Name</div>
        <div>${application.fatherFullName}</div>
      </div>
      <div>
        <div class="small">WhatsApp</div>
        <div>${application.whatsapp}</div>
      </div>
    </div>
    <div style="background:#f8fafc;padding:10px;border-radius:8px;margin-bottom:15px">
      <div class="small">Payment Details</div>
      <div>Method: ${application.paymentMethod}</div>
      <div>Transaction ID: ${application.transactionId}</div>
      <div>Status: <span class="status-pending">Pending Approval</span></div>
    </div>
  `;
  
  // Update applications list
  loadApplications();
}

function resetForm() {
  document.getElementById('applyForm').reset();
  document.getElementById('photoPreview').classList.add('hidden');
  showToast('Form has been reset', 'info');
}

function newApplication() {
  resetForm();
  document.getElementById('confirmationMessage').classList.add('hidden');
  document.getElementById('applyForm').classList.remove('hidden');
}

function copyRollNumber() {
  const rollNumber = document.getElementById('generatedRoll').textContent;
  navigator.clipboard.writeText(rollNumber)
    .then(() => showToast('Roll number copied to clipboard!', 'info'))
    .catch(() => showToast('Failed to copy roll number', 'error'));
}

function printApplication() {
  const printContent = `
    <html>
      <head>
        <title>Application Receipt - ${CONFIG.ACADEMY_NAME}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          .receipt { border: 2px solid #333; padding: 20px; border-radius: 10px; max-width: 600px; margin: 0 auto; }
          .header { text-align: center; margin-bottom: 20px; }
          .roll-number { font-size: 32px; font-weight: bold; color: #4f05fd; text-align: center; margin: 20px 0; }
          .details { margin: 20px 0; }
          .section { margin-bottom: 15px; }
          .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
        </style>
      </head>
      <body>
        <div class="receipt">
          <div class="header">
            <h2>${CONFIG.ACADEMY_NAME}</h2>
            <h3>Application Receipt</h3>
          </div>
          ${document.getElementById('applicationDetails').innerHTML}
          <div class="footer">
            <p>Keep this receipt for your records</p>
            <p>Generated on: ${new Date().toLocaleDateString()}</p>
          </div>
        </div>
      </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.print();
}

// ==================== APPLICATIONS LIST ====================
function loadApplications() {
  const applications = getApplications();
  const container = document.getElementById('applicationsContainer');
  
  if (applications.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#64748b">No applications yet</div>';
    return;
  }
  
  // Sort by latest first
  const sortedApplications = [...applications].reverse();
  
  let html = '';
  sortedApplications.slice(0, 10).forEach(app => {
    html += `
      <div class="result-row">
        <div>
          <div style="font-weight:bold">${app.fullName}</div>
          <div class="small">Roll: ${app.rollNumber} ‚Ä¢ Class: ${app.class}</div>
          <div class="small">Submitted: ${new Date(app.submissionDate).toLocaleDateString()}</div>
        </div>
        <div style="text-align:right">
          <div class="status-${app.status}">${app.status.toUpperCase()}</div>
          <button class="btn btn-ghost" onclick="viewApplication('${app.rollNumber}')" style="padding:5px 10px;font-size:12px">View</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  if (applications.length > 10) {
    container.innerHTML += `<div style="text-align:center;padding:10px;color:#64748b">+ ${applications.length - 10} more applications</div>`;
  }
}

function viewApplication(rollNumber) {
  const applications = getApplications();
  const application = applications.find(app => app.rollNumber === rollNumber);
  
  if (application) {
    document.getElementById('slipRollNumber').value = rollNumber;
    openSection('slip');
    generateSlip();
  }
}

// ==================== SLIP GENERATION ====================
function generateSlip() {
  const rollNumber = document.getElementById('slipRollNumber').value.trim();
  
  if (!rollNumber) {
    showToast('Please enter roll number', 'error');
    return;
  }
  
  const applications = getApplications();
  const application = applications.find(app => app.rollNumber === rollNumber);
  
  if (!application) {
    document.getElementById('slipContainer').innerHTML = `
      <div style="text-align:center;padding:40px;background:#fef2f2;border-radius:10px;">
        <div style="font-size:48px;margin-bottom:20px;">‚ùå</div>
        <h3 style="color:#dc2626">Roll Number Not Found</h3>
        <p>No application found with roll number: <strong>${rollNumber}</strong></p>
        <button class="btn btn-ghost" onclick="openSection('apply')" style="margin-top:20px">Submit Application</button>
      </div>
    `;
    return;
  }
  
  let slipHTML = `
    <div style="border:3px solid #4f05fd;border-radius:15px;padding:25px;background:#fff;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid #4f05fd;">
        <h2 style="color:#4f05fd;margin-bottom:10px;">${CONFIG.ACADEMY_NAME}</h2>
        <h3 style="color:#333;">Student Admit Slip</h3>
      </div>
      
      <div style="display:flex;gap:30px;margin-bottom:30px;">
        <div style="flex:1;">
          ${application.photo ? `<img src="${application.photo}" class="stu-photo" style="width:150px;height:180px;">` : ''}
        </div>
        <div style="flex:2;">
          <div style="margin-bottom:20px;">
            <div style="font-size:14px;color:#64748b;">ROLL NUMBER</div>
            <div style="font-size:36px;font-weight:bold;color:#4f05fd;letter-spacing:3px;">${application.rollNumber}</div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
            <div>
              <div class="small">Student Name</div>
              <div style="font-weight:bold;font-size:18px;">${application.fullName}</div>
            </div>
            <div>
              <div class="small">Class</div>
              <div style="font-weight:bold;font-size:18px;">${application.class}</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
            <div>
              <div class="small">Gender</div>
              <div>${application.gender}</div>
            </div>
            <div>
              <div class="small">Date of Birth</div>
              <div>${application.dob}</div>
            </div>
          </div>
          
          <div style="margin-bottom:15px;">
            <div class="small">Father's Name</div>
            <div>${application.fatherFullName}</div>
          </div>
          
          <div style="margin-bottom:15px;">
            <div class="small">WhatsApp Number</div>
            <div>${application.whatsapp}</div>
          </div>
        </div>
      </div>
      
      <div style="background:#f8fafc;padding:20px;border-radius:10px;margin-bottom:25px;">
        <h4 style="color:#4f05fd;margin-bottom:15px;">Payment Information</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
          <div>
            <div class="small">Application Fee</div>
            <div style="font-weight:bold;">Rs. ${application.fee}</div>
          </div>
          <div>
            <div class="small">Payment Method</div>
            <div>${application.paymentMethod}</div>
          </div>
          <div>
            <div class="small">Transaction ID</div>
            <div>${application.transactionId}</div>
          </div>
        </div>
        
        <div style="margin-top:15px;">
          <div class="small">Payment Status</div>
          <div>
            <span class="status-${application.status}" style="font-size:16px;">${application.status.toUpperCase()}</span>
            ${application.status === 'approved' ? '<span style="color:#10b981;margin-left:10px;">‚úì Verified</span>' : ''}
          </div>
        </div>
      </div>
      
      <div style="display:flex;justify-content:space-between;padding-top:20px;border-top:1px solid #e2e8f0;">
        <div style="text-align:center;">
          <div style="height:50px;margin-bottom:10px;"></div>
          <div class="small">Student Signature</div>
        </div>
        <div style="text-align:center;">
          <div style="height:50px;margin-bottom:10px;"></div>
          <div class="small">Director Signature</div>
        </div>
      </div>
      
      <div style="text-align:center;margin-top:25px;padding-top:15px;border-top:1px dashed #e2e8f0;">
        <div class="small">This slip is computer generated and valid only with official stamp</div>
        <div class="small">Generated on: ${new Date().toLocaleDateString()}</div>
      </div>
    </div>
    
    <div class="btn-row" style="justify-content:center;margin-top:25px;">
      <button class="btn btn-primary" onclick="printSlip()">üñ®Ô∏è Print Slip</button>
      <button class="btn btn-ghost" onclick="downloadSlip()">üì• Download PDF</button>
    </div>
  `;
  
  document.getElementById('slipContainer').innerHTML = slipHTML;
}

function printSlip() {
  window.print();
}

function downloadSlip() {
  showToast('PDF download feature would be implemented with server-side code', 'info');
}

// ==================== RESULT CHECKER ====================
function checkResult() {
  const rollNumber = document.getElementById('resultRollNumber').value.trim();
  
  if (!rollNumber) {
    showToast('Please enter roll number', 'error');
    return;
  }
  
  const applications = getApplications();
  const application = applications.find(app => app.rollNumber === rollNumber);
  
  if (!application) {
    document.getElementById('resultContainer').innerHTML = `
      <div style="text-align:center;padding:40px;background:#fef2f2;border-radius:10px;">
        <div style="font-size:48px;margin-bottom:20px;">‚ùå</div>
        <h3 style="color:#dc2626">Roll Number Not Found</h3>
        <p>No application found with roll number: <strong>${rollNumber}</strong></p>
      </div>
    `;
    return;
  }
  
  const marks = getMarks();
  const studentMarks = marks.filter(mark => mark.rollNumber === rollNumber);
  const totalMarks = studentMarks.reduce((sum, mark) => sum + mark.marks, 0);
  const average = studentMarks.length > 0 ? totalMarks / studentMarks.length : 0;
  
  let resultHTML = `
    <div style="border:3px solid #10b981;border-radius:15px;padding:25px;background:#fff;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid #10b981;">
        <h2 style="color:#10b981;margin-bottom:10px;">${CONFIG.ACADEMY_NAME}</h2>
        <h3 style="color:#333;">Student Result Card</h3>
      </div>
      
      <div style="display:flex;gap:30px;margin-bottom:30px;">
        <div style="flex:1;">
          ${application.photo ? `<img src="${application.photo}" class="stu-photo" style="width:150px;height:180px;">` : ''}
        </div>
        <div style="flex:2;">
          <div style="margin-bottom:20px;">
            <div style="font-size:14px;color:#64748b;">ROLL NUMBER</div>
            <div style="font-size:36px;font-weight:bold;color:#10b981;letter-spacing:3px;">${application.rollNumber}</div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
            <div>
              <div class="small">Student Name</div>
              <div style="font-weight:bold;font-size:18px;">${application.fullName}</div>
            </div>
            <div>
              <div class="small">Class</div>
              <div style="font-weight:bold;font-size:18px;">${application.class}</div>
            </div>
          </div>
          
          <div style="margin-bottom:15px;">
            <div class="small">Father's Name</div>
            <div>${application.fatherFullName}</div>
          </div>
        </div>
      </div>
      
      <div style="background:#f0fdf4;padding:20px;border-radius:10px;margin-bottom:25px;">
        <h4 style="color:#10b981;margin-bottom:15px;">üìä Examination Results</h4>
        
        ${studentMarks.length > 0 ? `
          <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));gap:15px;margin-bottom:20px;">
            ${studentMarks.map((mark, index) => `
              <div style="text-align:center;background:#fff;padding:15px;border-radius:8px;border:1px solid #d1fae5;">
                <div class="small">Test ${index + 1}</div>
                <div style="font-size:24px;font-weight:bold;color:#10b981;">${mark.marks}</div>
                <div class="small">out of 100</div>
              </div>
            `).join('')}
          </div>
          
          <div style="display:flex;justify-content:space-around;background:#fff;padding:20px;border-radius:8px;margin-top:20px;">
            <div style="text-align:center;">
              <div class="small">Total Tests</div>
              <div style="font-size:24px;font-weight:bold;">${studentMarks.length}</div>
            </div>
            <div style="text-align:center;">
              <div class="small">Total Marks</div>
              <div style="font-size:24px;font-weight:bold;">${totalMarks}</div>
            </div>
            <div style="text-align:center;">
              <div class="small">Average</div>
              <div style="font-size:24px;font-weight:bold;color:#10b981;">${average.toFixed(2)}%</div>
            </div>
            <div style="text-align:center;">
              <div class="small">Grade</div>
              <div style="font-size:24px;font-weight:bold;color:#${getGradeColor(average)};">${getGrade(average)}</div>
            </div>
          </div>
        ` : `
          <div style="text-align:center;padding:30px;">
            <div style="font-size:48px;margin-bottom:20px;">üìù</div>
            <h4 style="color:#64748b;">No Results Available</h4>
            <p>Results have not been uploaded yet for this student.</p>
          </div>
        `}
      </div>
      
      <div style="text-align:center;margin-top:25px;padding-top:15px;border-top:1px dashed #e2e8f0;">
        <div class="small">This result card is computer generated</div>
        <div class="small">Generated on: ${new Date().toLocaleDateString()}</div>
      </div>
    </div>
    
    <div class="btn-row" style="justify-content:center;margin-top:25px;">
      <button class="btn btn-primary" onclick="printResult()">üñ®Ô∏è Print Result</button>
      ${studentMarks.length > 0 ? `<button class="btn btn-ghost" onclick="shareResult()">üì§ Share Result</button>` : ''}
    </div>
  `;
  
  document.getElementById('resultContainer').innerHTML = resultHTML;
}

function getGrade(average) {
  if (average >= 90) return 'A+';
  if (average >= 80) return 'A';
  if (average >= 70) return 'B';
  if (average >= 60) return 'C';
  if (average >= 50) return 'D';
  return 'F';
}

function getGradeColor(average) {
  if (average >= 90) return '10b981';
  if (average >= 80) return '3b82f6';
  if (average >= 70) return '8b5cf6';
  if (average >= 60) return 'f59e0b';
  if (average >= 50) return 'f97316';
  return 'ef4444';
}

function printResult() {
  window.print();
}

function shareResult() {
  showToast('Share feature would be implemented with mobile integration', 'info');
}

// ==================== ADMIN FUNCTIONS ====================
function isAdminLoggedIn() {
  return localStorage.getItem('admin_logged_in') === 'true';
}

function adminLogin() {
  const password = document.getElementById('adminPassword').value;
  
  if (password === CONFIG.ADMIN_PASSWORD) {
    localStorage.setItem('admin_logged_in', 'true');
    showAdminDashboard();
    showToast('Admin login successful', 'info');
  } else {
    showToast('Invalid password', 'error');
  }
}

function adminLogout() {
  localStorage.removeItem('admin_logged_in');
  document.getElementById('loginSection').classList.remove('hidden');
  document.getElementById('adminDashboard').classList.add('hidden');
  document.getElementById('adminPassword').value = '';
  showToast('Admin logged out', 'info');
}

function showAdminDashboard() {
  document.getElementById('loginSection').classList.add('hidden');
  document.getElementById('adminDashboard').classList.remove('hidden');
  loadAdminTable();
}

function loadAdminTable() {
  const applications = getApplications();
  const marks = getMarks();
  const tableBody = document.getElementById('adminTableBody');
  
  // Update total count
  document.getElementById('totalApplications').textContent = applications.length;
  
  if (applications.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align:center;padding:40px;color:#64748b">
          No applications found
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  applications.forEach(app => {
    const studentMarks = marks.filter(mark => mark.rollNumber === app.rollNumber);
    const totalMarks = studentMarks.reduce((sum, mark) => sum + mark.marks, 0);
    const average = studentMarks.length > 0 ? totalMarks / studentMarks.length : 0;
    
    html += `
      <tr>
        <td>${app.rollNumber}</td>
        <td>
          <div>${app.fullName}</div>
          <div class="small">${app.fatherFullName}</div>
        </td>
        <td>${app.class}</td>
        <td>${app.whatsapp}</td>
        <td>Rs. ${app.fee}</td>
        <td>
          <select onchange="updateStatus('${app.rollNumber}', this.value)" style="padding:5px;border-radius:5px;border:1px solid #ddd;width:100%;">
            <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="approved" ${app.status === 'approved' ? 'selected' : ''}>Approved</option>
            <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
          </select>
        </td>
        <td>
          ${studentMarks.length > 0 ? `
            <div>Avg: ${average.toFixed(2)}%</div>
            <div class="small">(${studentMarks.length} tests)</div>
          ` : 'No marks'}
        </td>
        <td>
          <button onclick="editApplication('${app.rollNumber}')" style="padding:5px 10px;background:#3b82f6;color:white;border:none;border-radius:5px;margin-right:5px;cursor:pointer">Edit</button>
          <button onclick="deleteApplication('${app.rollNumber}')" style="padding:5px 10px;background:#ef4444;color:white;border:none;border-radius:5px;cursor:pointer">Delete</button>
        </td>
      </tr>
    `;
  });
  
  tableBody.innerHTML = html;
}

function updateStatus(rollNumber, status) {
  const applications = getApplications();
  const index = applications.findIndex(app => app.rollNumber === rollNumber);
  
  if (index !== -1) {
    applications[index].status = status;
    applications[index].approvedDate = new Date().toISOString();
    applications[index].approvedBy = 'Admin';
    
    if (saveApplications(applications)) {
      showToast(`Status updated to ${status} for roll ${rollNumber}`, 'info');
      loadAdminTable();
      updateStats();
    }
  }
}

function editApplication(rollNumber) {
  showToast('Edit feature would open a form with application details', 'info');
}

function deleteApplication(rollNumber) {
  showModal(
    'Delete Application',
    `Are you sure you want to delete application with roll number ${rollNumber}? This action cannot be undone.`,
    () => {
      const applications = getApplications();
      const filteredApplications = applications.filter(app => app.rollNumber !== rollNumber);
      
      if (saveApplications(filteredApplications)) {
        showToast(`Application ${rollNumber} deleted successfully`, 'info');
        loadAdminTable();
        updateStats();
      }
    }
  );
}

function addMarks() {
  const rollNumber = document.getElementById('marksRoll').value.trim();
  const marksValue = document.getElementById('marksValue').value;
  
  if (!rollNumber) {
    showToast('Please enter roll number', 'error');
    return;
  }
  
  if (!marksValue || marksValue < 0 || marksValue > 100) {
    showToast('Please enter valid marks (0-100)', 'error');
    return;
  }
  
  const applications = getApplications();
  const application = applications.find(app => app.rollNumber === rollNumber);
  
  if (!application) {
    showToast(`No application found with roll number ${rollNumber}`, 'error');
    return;
  }
  
  const marks = getMarks();
  marks.push({
    rollNumber: rollNumber,
    marks: parseInt(marksValue),
    addedDate: new Date().toISOString(),
    addedBy: 'Admin'
  });
  
  if (saveMarks(marks)) {
    showToast(`Marks added for roll ${rollNumber}`, 'info');
    document.getElementById('marksRoll').value = '';
    document.getElementById('marksValue').value = '';
    loadAdminTable();
  }
}

function exportData() {
  const applications = getApplications();
  const marks = getMarks();
  
  const data = {
    exportDate: new Date().toISOString(),
    academy: CONFIG.ACADEMY_NAME,
    applications: applications,
    marks: marks
  };
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `dua_academy_data_${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showToast('Data exported successfully', 'info');
}

function clearAllData() {
  showModal(
    'Clear All Data',
    '‚ö†Ô∏è WARNING: This will delete ALL applications, marks, and settings. This action cannot be undone!',
    () => {
      localStorage.removeItem(CONFIG.STORAGE_KEYS.APPLICATIONS);
      localStorage.removeItem(CONFIG.STORAGE_KEYS.MARKS);
      localStorage.removeItem(CONFIG.STORAGE_KEYS.NEXT_ROLL);
      
      showToast('All data has been cleared', 'warning');
      updateStats();
      loadAdminTable();
      loadApplications();
    }
  );
}

function createTestData() {
  const testApplications = [
    {
      id: 1,
      rollNumber: '801',
      firstName: 'Ali',
      lastName: 'Khan',
      fullName: 'Ali Khan',
      gender: 'Male',
      dob: '2005-05-15',
      cnic: '4220112345678',
      class: '10',
      previousSchool: 'Government High School',
      whatsapp: '03011234567',
      fatherFirstName: 'Ahmed',
      fatherLastName: 'Khan',
      fatherFullName: 'Ahmed Khan',
      fatherCnic: '4220112345679',
      fatherOccupation: 'Teacher',
      paymentMethod: 'JazzCash',
      transactionId: 'JC123456',
      senderNumber: '03011234567',
      fee: CONFIG.APPLICATION_FEE,
      status: 'approved',
      photo: '',
      submissionDate: '2024-01-15T10:30:00Z',
      approvedDate: '2024-01-16T14:20:00Z',
      approvedBy: 'Admin'
    },
    {
      id: 2,
      rollNumber: '802',
      firstName: 'Sara',
      lastName: 'Ahmed',
      fullName: 'Sara Ahmed',
      gender: 'Female',
      dob: '2006-08-22',
      cnic: '4220123456789',
      class: '9',
      previousSchool: 'Private School',
      whatsapp: '03021234567',
      fatherFirstName: 'Mohammad',
      fatherLastName: 'Ahmed',
      fatherFullName: 'Mohammad Ahmed',
      fatherCnic: '4220123456780',
      fatherOccupation: 'Business',
      paymentMethod: 'EasyPaisa',
      transactionId: 'EP789012',
      senderNumber: '03021234567',
      fee: CONFIG.APPLICATION_FEE,
      status: 'pending',
      photo: '',
      submissionDate: '2024-01-16T11:45:00Z',
      approvedDate: null,
      approvedBy: null
    },
    {
      id: 3,
      rollNumber: '803',
      firstName: 'Bilal',
      lastName: 'Raza',
      fullName: 'Bilal Raza',
      gender: 'Male',
      dob: '2004-03-10',
      cnic: '4220134567890',
      class: '11-Medical',
      previousSchool: 'Science College',
      whatsapp: '03031234567',
      fatherFirstName: 'Raza',
      fatherLastName: 'Ali',
      fatherFullName: 'Raza Ali',
      fatherCnic: '4220134567891',
      fatherOccupation: 'Doctor',
      paymentMethod: 'Bank Transfer',
      transactionId: 'BT456789',
      senderNumber: '03031234567',
      fee: CONFIG.APPLICATION_FEE,
      status: 'approved',
      photo: '',
      submissionDate: '2024-01-17T09:15:00Z',
      approvedDate: '2024-01-17T16:45:00Z',
      approvedBy: 'Admin'
    }
  ];
  
  const testMarks = [
    { rollNumber: '801', marks: 85, addedDate: '2024-01-20T10:00:00Z', addedBy: 'Admin' },
    { rollNumber: '801', marks: 90, addedDate: '2024-01-27T10:00:00Z', addedBy: 'Admin' },
    { rollNumber: '803', marks: 78, addedDate: '2024-01-20T10:00:00Z', addedBy: 'Admin' },
    { rollNumber: '803', marks: 82, addedDate: '2024-01-27T10:00:00Z', addedBy: 'Admin' }
  ];
  
  localStorage.setItem(CONFIG.STORAGE_KEYS.APPLICATIONS, JSON.stringify(testApplications));
  localStorage.setItem(CONFIG.STORAGE_KEYS.MARKS, JSON.stringify(testMarks));
  localStorage.setItem(CONFIG.STORAGE_KEYS.NEXT_ROLL, '804');
  
  showToast('Test data created successfully', 'info');
  updateStats();
  loadAdminTable();
  loadApplications();
}

function showStorageInfo() {
  const applications = getApplications();
  const marks = getMarks();
  
  const info = `
    Storage Information:
    ‚Ä¢ Applications: ${applications.length}
    ‚Ä¢ Marks Records: ${marks.length}
    ‚Ä¢ Next Roll Number: ${localStorage.getItem(CONFIG.STORAGE_KEYS.NEXT_ROLL) || CONFIG.START_ROLL_NUMBER}
    ‚Ä¢ Total Storage: ${JSON.stringify(localStorage).length} bytes
  `;
  
  alert(info);
}

// ==================== STATS AND UPDATES ====================
function updateStats() {
  const applications = getApplications();
  
  // Update sidebar stats
  document.getElementById('statsTotal').textContent = applications.length;
  document.getElementById('statsApproved').textContent = applications.filter(app => app.status === 'approved').length;
  document.getElementById('statsPending').textContent = applications.filter(app => app.status === 'pending').length;
  
  const latestRoll = applications.length > 0 
    ? applications[applications.length - 1].rollNumber 
    : '-';
  document.getElementById('statsLatestRoll').textContent = latestRoll;
  
  // Update admin dashboard if open
  if (document.getElementById('adminDashboard') && !document.getElementById('adminDashboard').classList.contains('hidden')) {
    document.getElementById('totalApplications').textContent = applications.length;
  }
}

// ==================== PHOTO PREVIEW ====================
document.getElementById('studentPhoto').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const preview = document.getElementById('previewImage');
  const previewContainer = document.getElementById('photoPreview');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      previewContainer.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  } else {
    previewContainer.classList.add('hidden');
  }
});

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  // Initialize
  updateStats();
  loadApplications();
  
  // Check if admin is already logged in
  if (isAdminLoggedIn()) {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    loadAdminTable();
  }
  
  // Set current date as max for DOB
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dob').max = today;
  
  // Show welcome message
  setTimeout(() => {
    showToast('Welcome to Dua Educational Academy Portal!', 'info');
  }, 1000);
  
  // Log storage info for debugging
  console.log('Storage initialized:', {
    applications: getApplications().length,
    marks: getMarks().length,
    nextRoll: localStorage.getItem(CONFIG.STORAGE_KEYS.NEXT_ROLL)
  });
});

// ==================== WINDOW EXPORTS ====================
window.openSection = openSection;
window.submitApplication = submitApplication;
window.resetForm = resetForm;
window.newApplication = newApplication;
window.copyRollNumber = copyRollNumber;
window.printApplication = printApplication;
window.generateSlip = generateSlip;
window.printSlip = printSlip;
window.downloadSlip = downloadSlip;
window.checkResult = checkResult;
window.printResult = printResult;
window.shareResult = shareResult;
window.adminLogin = adminLogin;
window.adminLogout = adminLogout;
window.updateStatus = updateStatus;
window.editApplication = editApplication;
window.deleteApplication = deleteApplication;
window.addMarks = addMarks;
window.exportData = exportData;
window.clearAllData = clearAllData;
window.createTestData = createTestData;
window.showStorageInfo = showStorageInfo;
</script>
</body>
</html>
