/* FIXED: Save Application Function - MODIFIED FOR BACKEND */
function saveApplication(snapshot, feeData, photoData, opts){
  try {
    const app = {
      roll: snapshot.roll,
      name: snapshot.name,
      surname: snapshot.surname,
      gender: snapshot.gender,
      dob: snapshot.dob,
      cnic: snapshot.cnic,
      class: snapshot.class,
      pastSchool: snapshot.pastSchool,
      whatsapp: snapshot.whatsapp,
      photo: photoData || '',
      feeImage: feeData || '',
      paymentStatus: opts.approved ? 'Approved' : 'Pending',
      appFee: snapshot.appFee,
      paymentSenderNumber: snapshot.paymentSenderNumber || '',
      fatherName: snapshot.fatherName,
      fatherSurname: snapshot.fatherSurname,
      fatherCnic: snapshot.fatherCnic,
      fatherOccupation: snapshot.fatherOccupation,
      txId: snapshot.txnId || '',
      createdAt: new Date().toISOString()
    };

    // --- MODIFICATION: Send data to the backend server ---
    // !!! IMPORTANT: Replace the URL below with the actual URL of your deployed server !!!
    const BACKEND_URL = 'http://localhost:3000/save-application'; 

    fetch(BACKEND_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(app),
    })
    .then(response => response.json())
    .then(data => {
        if(data.success){
            // Original success logic from line 948 onwards
            const applyConfirm = q('applyConfirm');
            const applyForm = q('applyForm');
            const paymentModal = q('paymentModal');
            
            applyConfirm.classList.remove('hidden');
            applyConfirm.innerHTML = `
                <div class="confirm-box">
                    <img src="${photoData || feeData || ''}" class="stu-photo" onerror="this.style.display='none'"/>
                    <div>
                        <div style="font-weight:800;color:#0f172a;font-size:18px;">‚úÖ Application Submitted Successfully!</div>
                        <div style="margin-top:8px"><strong>Roll Number:</strong> <span style="color:var(--accent);font-size:20px;">${app.roll}</span></div>
                        <div><strong>${escapeHtml(app.name)} ${escapeHtml(app.surname)}</strong> ‚Ä¢ ${escapeHtml(app.gender)}</div>
                        <div class="small">Class: ${escapeHtml(app.class)} ‚Ä¢ DOB: ${escapeHtml(app.dob)}</div>
                        <div class="small">Fee: ${app.appFee} ‚Ä¢ Status: <span style="color:orange">${app.paymentStatus}</span></div>
                        <div class="small">Payment From: <strong>${escapeHtml(app.paymentSenderNumber)}</strong></div>
                        <div class="small" style="margin-top:8px;color:orange;background:#fff3cd;padding:8px;border-radius:5px;">
                            ‚ö†Ô∏è Payment pending verification. Admin will verify within 24 hours.
                        </div>
                        <div style="margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="btn btn-primary" onclick="copyRoll('${app.roll}')">üìã Copy Roll</button>
                            <button class="btn btn-ghost" onclick="openSection('slip'); q('slip_roll').value='${app.roll}'; genSlip()">üëÅÔ∏è View Slip</button>
                            <button class="btn" onclick="applyFormReset()">‚ùå Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            applyForm.reset();
            applyForm.classList.add('hidden');
            paymentModal.style.display = 'none';
            paymentModal.setAttribute('aria-hidden','true');
            currentSnapshot = null;
            
            // The following functions will still rely on local storage unless you update them:
            // renderAppsList();
            // if(!q('adminArea').classList.contains('hidden')){ loadAdminData(); }
            
            showToast('‚úÖ Application saved successfully! Roll: ' + app.roll);
        } else {
            alert('Failed to save application to server: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving application:', error);
        alert('Network Error: Could not connect to the server. Check if the server is running and the URL is correct.');
    });
    // --- END OF MODIFICATION ---

  } catch (error) {
    console.error('Error in saveApplication:', error);
    alert('Error: ' + error.message);
  }
}
